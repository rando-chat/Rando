<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rando Chat - Matchmaking Debug</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 { font-size: 28px; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .content { padding: 30px; }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }
    .section h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    #logs {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-entry {
      margin-bottom: 4px;
      padding: 4px 0;
    }
    .log-time {
      color: #808080;
      margin-right: 8px;
    }
    .log-info { color: #4fc3f7; }
    .log-success { color: #81c784; }
    .log-error { color: #e57373; }
    .log-warn { color: #ffb74d; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Matchmaking Debug Tool</h1>
      <p>Real-time diagnostics for Rando Chat matchmaking</p>
    </div>

    <div class="content">
      <!-- Configuration -->
      <div class="section">
        <h2>üîß Configuration</h2>
        <p style="margin-bottom: 12px;">
          <strong>Status:</strong> <span id="configStatus" class="status pending">Not Connected</span>
        </p>
        <button class="btn-primary" onclick="initSupabase()">Connect to Supabase</button>
      </div>

      <!-- User Info -->
      <div class="section">
        <h2>üë§ Your Info</h2>
        <p><strong>User ID:</strong> <span id="userId">-</span></p>
        <p><strong>Display Name:</strong> <span id="displayName">-</span></p>
        <p><strong>Is Guest:</strong> <span id="isGuest">-</span></p>
      </div>

      <!-- Controls -->
      <div class="section">
        <h2>üéÆ Controls</h2>
        <button class="btn-primary" onclick="joinQueue()" id="joinBtn" disabled>
          Join Queue
        </button>
        <button class="btn-secondary" onclick="leaveQueue()" id="leaveBtn" disabled>
          Leave Queue
        </button>
        <button class="btn-danger" onclick="clearLogs()">
          Clear Logs
        </button>
        <button class="btn-secondary" onclick="checkQueue()">
          Check Queue
        </button>
        <button class="btn-secondary" onclick="checkSessions()">
          Check Sessions
        </button>
      </div>

      <!-- Stats -->
      <div class="section">
        <h2>üìä Live Stats</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="queueCount">-</div>
            <div class="stat-label">In Queue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="sessionCount">-</div>
            <div class="stat-label">Active Chats</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="pollCount">0</div>
            <div class="stat-label">Poll Count</div>
          </div>
        </div>
      </div>

      <!-- Logs -->
      <div class="section">
        <h2>üìù Debug Logs</h2>
        <div id="logs">Waiting for activity...</div>
      </div>
    </div>
  </div>

  <script>
    let supabase = null;
    let myUserId = null;
    let pollInterval = null;
    let pollCount = 0;

    // Generate UUID v4
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Logging
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const logs = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      logs.appendChild(entry);
      logs.scrollTop = logs.scrollHeight;
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = 'Logs cleared.';
    }

    // Initialize Supabase
    async function initSupabase() {
      const url = 'https://veuypmjwvgbaovccyxxo.supabase.co';
      const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZldXlwbWp3dmdiYW92Y2N5eHhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTU0NTYsImV4cCI6MjA4NDYzMTQ1Nn0.f61iB_VaQrADFqJWlXZ5X8RB4--vh5crMgG3tXWQrQs';
      
      supabase = window.supabase.createClient(url, key);
      log('Connecting to Supabase...', 'info');

      // Test connection
      try {
        const { data, error } = await supabase.from('matchmaking_queue').select('count').limit(1);
        if (error) throw error;
        
        log('‚úÖ Connected to Supabase successfully', 'success');
        document.getElementById('configStatus').className = 'status success';
        document.getElementById('configStatus').textContent = 'Connected';
        
        // Generate user ID
        myUserId = generateUUID();
        document.getElementById('userId').textContent = myUserId.slice(0, 8) + '...';
        document.getElementById('displayName').textContent = 'Guest_' + myUserId.slice(-4);
        document.getElementById('isGuest').textContent = 'Yes';
        
        document.getElementById('joinBtn').disabled = false;
        
        // Start stats refresh
        setInterval(updateStats, 3000);
        updateStats();
        
      } catch (error) {
        log('‚ùå Failed to connect: ' + error.message, 'error');
        document.getElementById('configStatus').className = 'status error';
        document.getElementById('configStatus').textContent = 'Error';
      }
    }

    // Update stats
    async function updateStats() {
      if (!supabase) return;
      
      try {
        const [{ count: queueCount }, { count: sessionCount }] = await Promise.all([
          supabase.from('matchmaking_queue').select('id', { count: 'exact', head: true }).is('matched_at', null),
          supabase.from('chat_sessions').select('id', { count: 'exact', head: true }).eq('status', 'active'),
        ]);
        
        document.getElementById('queueCount').textContent = queueCount || 0;
        document.getElementById('sessionCount').textContent = sessionCount || 0;
      } catch (error) {
        log('Error updating stats: ' + error.message, 'error');
      }
    }

    // Join queue
    async function joinQueue() {
      if (!supabase || !myUserId) return;
      
      log('üéØ Joining matchmaking queue...', 'info');
      document.getElementById('joinBtn').disabled = true;
      
      try {
        // Clean up old entry
        await supabase.from('matchmaking_queue').delete().eq('user_id', myUserId);
        
        // Insert
        const { error } = await supabase.from('matchmaking_queue').insert({
          user_id: myUserId,
          display_name: 'Guest_' + myUserId.slice(-4),
          is_guest: true,
          tier: 'free',
          interests: [],
          matched_at: null,
          entered_at: new Date().toISOString(),
        });
        
        if (error) throw error;
        
        log('‚úÖ Joined queue successfully', 'success');
        document.getElementById('leaveBtn').disabled = false;
        
        // Start polling
        pollCount = 0;
        pollInterval = setInterval(pollForMatch, 2000);
        setTimeout(pollForMatch, 500);
        
      } catch (error) {
        log('‚ùå Failed to join queue: ' + error.message, 'error');
        document.getElementById('joinBtn').disabled = false;
      }
    }

    // Poll for match
    async function pollForMatch() {
      if (!supabase || !myUserId) return;
      
      pollCount++;
      document.getElementById('pollCount').textContent = pollCount;
      
      try {
        log(`üîÑ Poll #${pollCount}: Checking for match...`, 'info');
        
        // Check for existing session
        const { data: existingSession } = await supabase
          .from('chat_sessions')
          .select('*')
          .or(`user1_id.eq.${myUserId},user2_id.eq.${myUserId}`)
          .eq('status', 'active')
          .maybeSingle();
        
        if (existingSession) {
          log('‚úÖ MATCH FOUND! Session ID: ' + existingSession.id, 'success');
          clearInterval(pollInterval);
          alert('Match found! Session ID: ' + existingSession.id);
          return;
        }
        
        // Check queue
        const { data: allInQueue } = await supabase
          .from('matchmaking_queue')
          .select('*')
          .is('matched_at', null)
          .order('entered_at', { ascending: true });
        
        log(`   üìã Total in queue: ${allInQueue?.length || 0}`, 'info');
        
        if (allInQueue && allInQueue.length > 0) {
          allInQueue.forEach((entry, i) => {
            const isMe = entry.user_id === myUserId;
            log(`   ${i + 1}. ${entry.user_id.slice(0, 8)}... ${isMe ? '(ME)' : ''}`, 'info');
          });
        }
        
        // Find partner
        const partner = allInQueue?.find(e => e.user_id !== myUserId);
        
        if (!partner) {
          log('   ‚è≥ No partner yet, waiting...', 'warn');
          return;
        }
        
        log(`   üë• Found partner: ${partner.user_id.slice(0, 8)}...`, 'success');
        
        // Check if I should create session
        const shouldCreate = myUserId < partner.user_id;
        log(`   üé≤ Should I create? ${shouldCreate}`, 'info');
        
        if (shouldCreate) {
          log('   üî® Creating chat session...', 'info');
          
          // Mark both as matched
          await supabase
            .from('matchmaking_queue')
            .update({ matched_at: new Date().toISOString() })
            .in('user_id', [myUserId, partner.user_id]);
          
          // Create session
          const { data: session, error: sessionError } = await supabase
            .from('chat_sessions')
            .insert({
              user1_id: myUserId,
              user2_id: partner.user_id,
              user1_display_name: 'Guest_' + myUserId.slice(-4),
              user2_display_name: partner.display_name || 'Anonymous',
              status: 'active',
              started_at: new Date().toISOString(),
            })
            .select()
            .single();
          
          if (sessionError) {
            log('   ‚ùå Session creation failed: ' + sessionError.message, 'error');
            // Revert
            await supabase
              .from('matchmaking_queue')
              .update({ matched_at: null })
              .in('user_id', [myUserId, partner.user_id]);
            return;
          }
          
          log('   ‚úÖ Session created: ' + session.id, 'success');
          
          // Clean up
          await supabase.from('matchmaking_queue').delete().in('user_id', [myUserId, partner.user_id]);
          
          clearInterval(pollInterval);
          alert('‚úÖ MATCHED! Session: ' + session.id);
        } else {
          log('   ‚è≥ Waiting for partner to create session...', 'warn');
        }
        
      } catch (error) {
        log('‚ùå Polling error: ' + error.message, 'error');
      }
    }

    // Leave queue
    async function leaveQueue() {
      if (!supabase || !myUserId) return;
      
      log('üö™ Leaving queue...', 'info');
      
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      
      try {
        await supabase.from('matchmaking_queue').delete().eq('user_id', myUserId);
        log('‚úÖ Left queue', 'success');
        
        document.getElementById('joinBtn').disabled = false;
        document.getElementById('leaveBtn').disabled = true;
        pollCount = 0;
        document.getElementById('pollCount').textContent = '0';
        
      } catch (error) {
        log('‚ùå Error leaving queue: ' + error.message, 'error');
      }
    }

    // Check queue
    async function checkQueue() {
      if (!supabase) return;
      
      log('üîç Checking queue...', 'info');
      
      try {
        const { data, error } = await supabase
          .from('matchmaking_queue')
          .select('*')
          .is('matched_at', null)
          .order('entered_at', { ascending: true });
        
        if (error) throw error;
        
        log(`üìã Queue has ${data.length} users:`, 'info');
        data.forEach((entry, i) => {
          log(`   ${i + 1}. user_id: ${entry.user_id.slice(0, 12)}..., name: ${entry.display_name}`, 'info');
        });
        
      } catch (error) {
        log('‚ùå Error checking queue: ' + error.message, 'error');
      }
    }

    // Check sessions
    async function checkSessions() {
      if (!supabase) return;
      
      log('üîç Checking active sessions...', 'info');
      
      try {
        const { data, error } = await supabase
          .from('chat_sessions')
          .select('*')
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(10);
        
        if (error) throw error;
        
        log(`üí¨ Found ${data.length} active sessions:`, 'info');
        data.forEach((session, i) => {
          log(`   ${i + 1}. ${session.id}: ${session.user1_display_name} ‚Üî ${session.user2_display_name}`, 'info');
        });
        
      } catch (error) {
        log('‚ùå Error checking sessions: ' + error.message, 'error');
      }
    }

    // Auto-init on load
    window.onload = () => {
      log('üöÄ Debug tool loaded. Click "Connect to Supabase" to start.', 'info');
    };
  </script>
</body>
</html>