'use client'

import { useState, useEffect } from 'react'
import { DashboardLayout } from '@/components/admin/DashboardLayout'
import { supabase } from '@/lib/supabase/client'

export default function MonitoringPage() {
  const [health, setHealth] = useState<any>(null)
  const [logs, setLogs] = useState<any[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadHealth()
    loadLogs()
    const interval = setInterval(() => {
      loadHealth()
      loadLogs()
    }, 10000) // refresh every 10s
    return () => clearInterval(interval)
  }, [])

  const loadHealth = async () => {
    try {
      const res = await fetch('/api/health')
      const data = await res.json()
      setHealth(data)
    } catch (error) {
      console.error('Error loading health:', error)
    } finally {
      setLoading(false)
    }
  }

  const loadLogs = async () => {
    try {
      // Get recent audit logs
      const { data } = await supabase
        .from('audit_logs')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(20)
      setLogs(data || [])
    } catch (error) {
      console.error('Error loading logs:', error)
    }
  }

  if (loading) {
    return (
      <DashboardLayout>
        <div style={{ padding: 40, textAlign: 'center', color: '#9ca3af' }}>
          Loading monitoring data...
        </div>
      </DashboardLayout>
    )
  }

  const getStatusColor = (status: string) => {
    if (status === 'healthy') return '#22c55e'
    if (status === 'degraded') return '#f59e0b'
    return '#ef4444'
  }

  const getStatusBg = (status: string) => {
    if (status === 'healthy') return '#f0fdf4'
    if (status === 'degraded') return '#fffbeb'
    return '#fef2f2'
  }

  return (
    <DashboardLayout>
      <div style={{ maxWidth: 1200, margin: '0 auto' }}>
        <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 32 }}>
          System Monitoring
        </h1>

        {/* Overall Status */}
        <div style={{
          padding: 24,
          background: health ? getStatusBg(health.status) : 'white',
          borderRadius: 12,
          marginBottom: 24,
          border: `2px solid ${health ? getStatusColor(health.status) : '#e5e7eb'}`,
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
              <h2 style={{ fontSize: 20, fontWeight: 700, marginBottom: 4 }}>
                System Status: {health?.status?.toUpperCase()}
              </h2>
              <p style={{ fontSize: 14, color: '#6b7280' }}>
                Last checked: {health ? new Date(health.timestamp).toLocaleString() : 'N/A'}
              </p>
            </div>
            <div style={{
              width: 60,
              height: 60,
              borderRadius: '50%',
              background: health ? getStatusColor(health.status) : '#e5e7eb',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: 28,
            }}>
              {health?.status === 'healthy' ? '✓' : health?.status === 'degraded' ? '!' : '✗'}
            </div>
          </div>

          {health?.errors && health.errors.length > 0 && (
            <div style={{ marginTop: 16, padding: 12, background: '#fef2f2', borderRadius: 8 }}>
              <p style={{ fontSize: 14, fontWeight: 600, color: '#ef4444', marginBottom: 8 }}>
                Errors:
              </p>
              {health.errors.map((err: string, i: number) => (
                <p key={i} style={{ fontSize: 13, color: '#991b1b', marginBottom: 4 }}>
                  • {err}
                </p>
              ))}
            </div>
          )}
        </div>

        {/* Services Grid */}
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: 16, marginBottom: 24 }}>
          {health?.services && Object.entries(health.services).map(([service, status]: [string, any]) => (
            <div key={service} style={{
              padding: 20,
              background: 'white',
              borderRadius: 12,
              boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
              borderLeft: `4px solid ${getStatusColor(status)}`,
            }}>
              <div style={{ fontSize: 14, color: '#6b7280', marginBottom: 8, textTransform: 'capitalize' }}>
                {service}
              </div>
              <div style={{
                fontSize: 18,
                fontWeight: 700,
                color: getStatusColor(status),
                textTransform: 'uppercase',
              }}>
                {status}
              </div>
            </div>
          ))}
        </div>

        {/* Metrics */}
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16, marginBottom: 24 }}>
          {health?.metrics && Object.entries(health.metrics).map(([metric, value]: [string, any]) => (
            <div key={metric} style={{
              padding: 20,
              background: 'white',
              borderRadius: 12,
              boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
            }}>
              <div style={{ fontSize: 14, color: '#6b7280', marginBottom: 8, textTransform: 'capitalize' }}>
                {metric.replace(/([A-Z])/g, ' $1').trim()}
              </div>
              <div style={{ fontSize: 32, fontWeight: 700, color: '#7c3aed' }}>
                {value.toLocaleString()}
              </div>
            </div>
          ))}
        </div>

        {/* Recent Logs */}
        <div style={{
          background: 'white',
          borderRadius: 12,
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
          overflow: 'hidden',
        }}>
          <div style={{ padding: 20, borderBottom: '1px solid #e5e7eb' }}>
            <h2 style={{ fontSize: 18, fontWeight: 700 }}>Recent Activity</h2>
          </div>
          <div style={{ maxHeight: 400, overflowY: 'auto' }}>
            {logs.length === 0 ? (
              <div style={{ padding: 40, textAlign: 'center', color: '#9ca3af' }}>
                No activity logs yet
              </div>
            ) : (
              logs.map((log, i) => (
                <div key={log.id || i} style={{
                  padding: 16,
                  borderBottom: i < logs.length - 1 ? '1px solid #f3f4f6' : 'none',
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: 4 }}>
                    <span style={{ fontSize: 14, fontWeight: 600, color: '#1f2937' }}>
                      {log.action_type}
                    </span>
                    <span style={{ fontSize: 12, color: '#9ca3af' }}>
                      {new Date(log.created_at).toLocaleString()}
                    </span>
                  </div>
                  {log.resource_type && (
                    <div style={{ fontSize: 13, color: '#6b7280' }}>
                      {log.resource_type}: {log.resource_id}
                    </div>
                  )}
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </DashboardLayout>
  )
}